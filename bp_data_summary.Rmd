---
title: "Bonepile Data Summary"
author: "Annie Kellner"
date: "2/9/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r clear-workspace-if-needed}

rm(list = ls())

```


```{r libraries, include=FALSE, message=FALSE}

library(sf)
library(tidyverse)
library(amt)
library(tmap)
library(tmaptools)
library(adehabitatLT)
library(adehabitatHR)
library(data.table)
library(knitr)
library(here)
library(conflicted)

conflicts_prefer(
  dplyr::filter()
)

```

```{r load-and-prep-data, message=FALSE, warning=FALSE, echo=FALSE}

## NOTE: for use with adehabitatLT, input must be data.frame and not tbl

# Bears

b <- readRDS(here("Data", "Derived-data", "DFs", "OG", "OG_090323.Rds"))
b <- as.data.frame(b)

# Bonepile points 

u <- b %>% filter(at_bonepile == 1)  # load all bonepile points

```

Number of locations per bear

```{r days-tracked}

# Create track in adehabitatLT

ltraj <- as.ltraj(xy=u[,c("Xaa","Yaa")], date=u$datetime, id=as.character(u$id))

trajdf <- ld(ltraj)
trajdf$dt <- trajdf$dt/3600 # convert dt to hours

trajdf$hrRate <- trajdf$dist/trajdf$dt

summary <- summary(ltraj)

summary$DaysTrack <-round(difftime(summary$date.end, summary$date.begin, units="days"),digits=1)
summary <- dplyr::select(summary, id, date.begin, date.end, DaysTrack)

summary

summary$DaysTrack <- as.numeric(summary$DaysTrack)
sd(summary$DaysTrack)
```

# MCP's

```{r mcp}

# MCP95 looks better than MCP99

usf <- st_as_sf(u, coords = c('Xaa','Yaa'), crs = 3338)

# Add which bonepile for summary stats

Bonepiles_visited <- read_csv("Data/Derived-data/Bonepile/Bonepiles_visited.csv")

usf <- left_join(usf, Bonepiles_visited)

usp <- dplyr::select(usf, id,geometry)
usp <- as_Spatial(usp)


mcp95 <- mcp(usp, percent = 95)
mcp95sf <- st_as_sf(mcp95)

area_by_bonepile <- mcp95sf %>% 
  left_join(Bonepiles_visited) %>%
  group_by(Bonepile) %>%
  summarize(mean_area = mean(area))

tmap_mode('view')

tm_shape(mcp95sf) + 
  tm_polygons(col = "id", alpha = 0.4, legend.show = FALSE)

# Save bonepile MCP's as spatial object

#saveRDS(mcp95sf, here("Data", "Derived-data", "Spatial", "MCP95_bonepile_bears.Rds"))


```


# Plot used v. available points

```{r create-used-avail-pts, echo=FALSE}
# Make track with package amt



track <- make_track(u, .x = Xaa, .y = Yaa, crs = 3338, id = id) # makes one big track with all animals
trk <- track %>% nest(data = -"id") # creates dataframes for each individual

# Create random points using 95 MCP for each individual

rsf <- data.frame(case_ = logical(), x_ = double(), y_ = double(), id = character())
ids <- unique(u$id)

for(i in 1:length(ids)){
  bear_trk = trk$data[[i]]
  hr = hr_mcp(bear_trk, levels = 0.95)
  rsf_pts = random_points(hr, n = 20*nrow(bear_trk), presence = bear_trk)
  rsf_pts$id = ids[i]
  rsf = rbind(rsf, rsf_pts)
}

#saveRDS(rsf, here("Data", "Derived-data", "DFs", "OG", "bonepile_pts_ua_090323.Rds"))

```


```{r plot random v used}

# Plot random v matched points
ggplot(rsf, aes(x_, y_, color=case_))+
  geom_point()+
  facet_wrap(~id, scales="free")
```


