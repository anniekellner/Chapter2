---
title: "Space_Use_Summaries_Ch2"
author: "Annie Kellner"
date: "2022-09-15"
output: html_document
---

```{r setup, include=FALSE, message=FALSE}

knitr::opts_chunk$set(echo = FALSE)

```

```{r}

library(knitr)
library(kableExtra)
library(plyr)
library(dplyr) # always load plyr before dplyr
library(tidyr)
library(sf)
library(ggplot2)
library(lubridate)
library(conflicted)
#library(tmap)
#library(tmaptools)

conflicts_prefer(
  dplyr::select(),
  dplyr::filter(),
  dplyr::mutate()
)

rm(list = ls())

```



# Basic summary tables for bears that visit the bonepile and those that do not

## How many bears visit the bonepile and how many do not?


```{r bonepile-vs-not}

pb <- readRDS('./Data/Derived-data/DFs/bears_ch2_052823.Rds')

pb2 <- pb %>%
  mutate(bear_type = case_when(
    id == "pb_32255.2008" | id == "pb_20418.2005" | 
      id == "pb_20414.2009" ~ "Do Not Visit Bonepile",
    TRUE ~ "Visit Bonepile"
  ))

# Individual bears

ind <- pb2 %>%
  group_by(id) %>%
  slice_head() 

t <- as.data.frame(table(ind$bear_type))[c(2,1),]

kable(t, col.names = NULL, row.names = FALSE)

```

# What is the age breakdown associated with each bear type?

```{r}

ind2 <- ind %>%
  mutate(age_class = 
           case_when(
             age < 5 ~ "Subadult",
             TRUE ~ "Adult"
           ))

kable(table(ind2$age_class, ind2$bear_type))

```

A Fisher's Exact Test shows no association between age class and whether or not the bear stays at the bonepile: 
`r fisher.test(ind2$age_class, ind2$bear_type)`


# What is the reproductive status associated with each bear type?


```{r}

kable(table(ind2$repro, ind2$bear_type)[c(2,1,3),])

```

It is noteworthy that all females with COYS visit the bonepile. This makes sense, as COYs are vulnerable to starvation and infanticide is not likely to be a threat when food is abundant. 

If yearlings and COYs are combined, is there an association with 'dependent young' and the bonepile?

```{r}

r <- ind2 %>%
  dplyr::select(id, repro, bear_type, age_class) 

r <- r %>%
  dplyr::mutate(young = case_when( 
    repro == "coy" | repro == "yearling" ~ "yes",
    TRUE ~ "no"
  ))

fisher.test(r$young, r$bear_type)
```

There is not an association between having dependent young and the bonepile. Cannot test for having a COY in particular because the sample size is too small. 


# How much time do bears spend at the bonepile vs. along the coastal corridor?

```{r}

# Bonepile
bpt <- readRDS('./Data/Derived-data/DFs/Space_Use_Summaries/time_at_bonepile.Rds')

## To get summary of time spent, have to add 20735's stints together and remove second entry

bpt$time_spent <- as.numeric(bpt$time_spent)
bpt[17,4] <- sum(bpt[17,4] + bpt[18,4])

bpt[-18,] -> bpt

bpt2 <- bpt %>%
  select(id, time_spent) %>%
  mutate(where = "Bonepile") %>%
  dplyr::rename(time = time_spent) # because also in Plyr so gives error

# Corridor
cor <- readRDS('./Data/Derived-data/DFs/Space_Use_Summaries/time_along_corr.Rds')

cor$time <- as.numeric(cor$time)
cor$where <- "Corridor"

```

Summary stats for time at the bonepile: `r summary(bpt2$time)`
Summary stats for time along the coastal corridor: `r summary(cor$time)`

Results of a t-test comparing the means: `r t.test(bpt2$time, cor$time)`

Conclusion: bears spend more time onshore at the bonepile than they do along the coastal corridor.


# How many bears visit each bonepile?

```{r, include=FALSE}

b <- bpt2 %>%
  mutate(bonepile = if_else(
    id == "pb_20492.2008" | id == "pb_20520.2012" | id == "pb_20735.2009" | id == "pb_20966.2008" | 
      id == "pb_20982.2008" | id == "pb_32282.2008" | id == "pb_32366.2011" | id == "pb_32608.2008",
    "Kaktovik", "Cross"
  )) %>%
  glimpse()

```

`r table(b$bonepile)`

```{r harvest-data}

bpt$year <- year(bpt$start)
years <- unique(bpt$year)

# Load harvest data

harvest <- read.csv('./Data/Bonepile_Dates.csv')

harvest$Dates <- mdy(harvest$Dates)
harvest$Year <- year(harvest$Dates)

h <- harvest %>%
  filter(Year %in% years) 

h <- h %>%
  filter(!(Bonepile == "Barrow"))

bpt <- bpt %>%
    mutate(bonepile = if_else(
    id == "pb_20492.2008" | id == "pb_20520.2012" | id == "pb_20735.2009" | id == "pb_20966.2008" | 
      id == "pb_20982.2008" | id == "pb_32282.2008" | id == "pb_32366.2011" | id == "pb_32608.2008",
    "Kaktovik", "Cross"
  ))

```






Because the bonepile acts as a focal attractant, we predict bears will exhibit distinct behavior when foraging at the bonepile relative to other activities (i.e., resting or traveling along the coastal corridor). 

To separate 'bonepile' locations from others, we plotted net-squared distance (NSD) values over time for each individual, expecting the following patterns (adapted from Bunnefeld et al. 2011 - PROVIDE HYPERLINK): 

  * Coast & Bonepile Bears = Bears with 'dispersing' NSD patterns
    + These bears typically arrive on land and travel along the coast to the bonepile,
    | or arrive at the bonepile and then travel along the coast after they leave
    
  * Bonepile-only Bears = Bears with 'home range' NSD patterns
    + These bears arrive at the bonepile and do not leave for the duration of the study
    
  * Coast Bears = Bears who do not visit any bonepiles
    + These bears can exhibit any type of NSD pattern

We then validated our methodology by mapping the geographic locations of each category of point, and also identified animals who a) arrived on land directly at the bonepile or b) stayed for an extended time in a location that was not the bonepile. 

[insert NSD plot here]


After conducting NSD analysis, we can validate the methodology visually by mapping the two types of points

```{r}

## Could make three-part static plot if I have time with bp points, corridor points, and both

nsd <- readRDS('./Data/Derived-data/DFs/bears_ch2_092122.Rds') # df with at_bonepile

bones <- st_read('./Data/Spatial/Bonepiles/bonepiles.shp') %>% # bonepile shp
  st_transform(3338)

nsd <- st_as_sf(nsd) %>% # make into sf object
  st_set_crs(3338) 

nsd$at_bonepile <- as.factor(nsd$at_bonepile) # so legend shows 0 and 1 rather than 0-1 continuous scale

tmap_mode('view') # interactive map

tm_shape(bones) + 
  tm_dots(col = "blue", size = 0.5) + 
  tm_shape(nsd) + 
  tm_dots(col = "at_bonepile")

```






